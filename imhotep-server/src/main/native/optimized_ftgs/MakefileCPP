##
# This is not a standalone makefile, just a step in the direction of
# decluttering Makefile a bit by separating out the cpp-specific
# stuff.
#

CPP=g++
CPP_INCLUDES=\
	-Iinclude \
	-Icpp/include \
	-I$(JAVA_HOME)/include \
	-I$(JAVA_HOME)/include/linux \
	-I/usr/include/boost

BASE_CPPFLAGS=-Wall -Werror $(CPP_INCLUDES) -msse4.2 -std=c++11 -fPIC -fno-omit-frame-pointer
BASE_LFLAGS= -shared  -fno-omit-frame-pointer

DBG_CPPFLAGS= -g -fno-omit-frame-pointer
OPT_CPPFLAGS= -g -O3 # -flto

DBG_LFLAGS= -g -fsanitize=address -fno-omit-frame-pointer
OPT_LFLAGS= -g -O3 # -flto-partition=none -flto

ifeq ($(MODE),opt)
	CPPFLAGS=$(OPT_CPPFLAGS) $(BASE_CPPFLAGS)
else
	CPPFLAGS= $(DBG_CPPFLAGS) $(BASE_CPPFLAGS)
endif

CPPOBJ_DIR=$(BUILD_DIR)/cppobj

CPP_FILES := $(wildcard cpp/src/*.cpp)
HPP_FILES := $(wildcard cpp/include/*.hpp)
CPP_OBJ_FILES += $(addprefix $(CPPOBJ_DIR)/,$(notdir $(CPP_FILES:.cpp=.o)))

$(CPPOBJ_DIR)/%.o: cpp/src/%.cpp $(HPP_FILES) include/imhotep_native.h include/local_session.h
	$(CPP) $(CPPFLAGS) -include include/gcc_preinclude.h -c -o $@ $<


